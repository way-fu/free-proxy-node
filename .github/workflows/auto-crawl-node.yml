name: è‡ªåŠ¨æŠ“å–å…è´¹èŠ‚ç‚¹å¹¶ç”ŸæˆShadowrocketé…ç½®
on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å‘¨ä¸€ã€å‘¨å›› 08:00 æ‰§è¡Œï¼ˆUTCæ—¶åŒºï¼Œå¯¹åº”å›½å†…16:00ï¼Œå¯è‡ªè¡Œè°ƒæ•´ï¼‰
  schedule:
    - cron: '0 0 * * 1,4'
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
  workflow_dispatch:
  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
  push:
    branches: [main]

# æƒé™é…ç½®ï¼šå…è®¸è¯»å†™ä»“åº“ã€æ¨é€ä»£ç 
permissions:
  contents: write

jobs:
  crawl-node:
    runs-on: ubuntu-latest  # ä½¿ç”¨Ubuntuè™šæ‹Ÿæœºè¿è¡Œ
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“ä»£ç åˆ°è™šæ‹Ÿæœº
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–æ‰€æœ‰å†å²ï¼Œé¿å…æäº¤å¤±è´¥

      # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒï¼ˆåŒ¹é…è„šæœ¬ä¾èµ–ï¼‰
      - name: é…ç½®Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"  # ç¼“å­˜pipä¾èµ–ï¼ŒåŠ å¿«è¿è¡Œé€Ÿåº¦

      # æ­¥éª¤3ï¼šå®‰è£…Pythonä¾èµ–
      - name: å®‰è£…ä¾èµ–åŒ…
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml base64 cryptography

      # æ­¥éª¤4ï¼šè¿è¡ŒPythonè„šæœ¬ï¼Œç”ŸæˆShadowrocket YAML
      - name: è¿è¡ŒèŠ‚ç‚¹æŠ“å–è„šæœ¬
        run: python crawl_node.py

      # æ­¥éª¤5ï¼šæäº¤ç”Ÿæˆçš„YAMLæ–‡ä»¶åˆ°ä»“åº“
      - name: æäº¤å¹¶æ¨é€ä»£ç 
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯ï¼ˆActionsæœºå™¨äººï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          git add shadowrocket.yaml
          git diff --quiet || git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹ï¼š$(date +'%Y-%m-%d %H:%M:%S')"
          # æ¨é€å˜æ›´åˆ°mainåˆ†æ”¯
          git push origin main
